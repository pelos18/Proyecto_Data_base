<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Administrador - Sistema de Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-crown me-2"></i>Panel de Administración
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-user-shield me-1"></i>
                    Admin: <span th:text="${usuario.nombre}"></span>
                </span>
                <a class="nav-link" href="/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Cerrar Sesión
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 bg-light vh-100 p-3">
                <div class="nav flex-column nav-pills">
                    <button class="nav-link active" onclick="mostrarSeccion('dashboard')">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </button>
                    <button class="nav-link" onclick="mostrarSeccion('productos')">
                        <i class="fas fa-box me-2"></i>Productos
                    </button>
                    <button class="nav-link" onclick="mostrarSeccion('inventario')">
                        <i class="fas fa-warehouse me-2"></i>Inventario
                    </button>
                    <button class="nav-link" onclick="mostrarSeccion('ventas')">
                        <i class="fas fa-chart-line me-2"></i>Ventas
                    </button>
                    <button class="nav-link" onclick="mostrarSeccion('clientes')">
                        <i class="fas fa-users me-2"></i>Clientes
                    </button>
                    <button class="nav-link" onclick="mostrarSeccion('proveedores')">
                        <i class="fas fa-truck me-2"></i>Proveedores
                    </button>
                    <button class="nav-link" onclick="mostrarSeccion('reportes')">
                        <i class="fas fa-file-alt me-2"></i>Reportes
                    </button>
                    <button class="nav-link" onclick="mostrarSeccion('usuarios')">
                        <i class="fas fa-user-cog me-2"></i>Usuarios
                    </button>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="col-md-10 p-4">
                <!-- Sección Dashboard -->
                <div id="seccion-dashboard" class="seccion">
                    <h2><i class="fas fa-tachometer-alt me-2"></i>Dashboard General</h2>
                    
                    <!-- Tarjetas de Resumen -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5>Productos</h5>
                                            <h2 id="totalProductos">0</h2>
                                        </div>
                                        <i class="fas fa-box fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5>Ventas Hoy</h5>
                                            <h2 id="ventasHoy">$0</h2>
                                        </div>
                                        <i class="fas fa-dollar-sign fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5>Stock Bajo</h5>
                                            <h2 id="stockBajo">0</h2>
                                        </div>
                                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5>Clientes</h5>
                                            <h2 id="totalClientes">0</h2>
                                        </div>
                                        <i class="fas fa-users fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Ventas de los Últimos 7 Días</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="chartVentas"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>Productos Más Vendidos</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="chartProductos"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección Productos -->
                <div id="seccion-productos" class="seccion" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2><i class="fas fa-box me-2"></i>Gestión de Productos</h2>
                        <button class="btn btn-primary" onclick="nuevoProducto()">
                            <i class="fas fa-plus me-2"></i>Nuevo Producto
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="tablaProductos">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nombre</th>
                                            <th>Código</th>
                                            <th>Categoría</th>
                                            <th>Marca</th>
                                            <th>Stock</th>
                                            <th>Precio</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Productos se cargan aquí -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección Inventario -->
                <div id="seccion-inventario" class="seccion" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2><i class="fas fa-warehouse me-2"></i>Control de Inventario</h2>
                        <div>
                            <button class="btn btn-success me-2" onclick="nuevoLote()">
                                <i class="fas fa-plus me-2"></i>Nuevo Lote
                            </button>
                            <button class="btn btn-info" onclick="imprimirInventario()">
                                <i class="fas fa-print me-2"></i>Imprimir Inventario
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h5>Productos por Vencer</h5>
                                    <h3 id="productosVencer">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h5>Stock Mínimo</h5>
                                    <h3 id="stockMinimo">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h5>Lotes Activos</h5>
                                    <h3 id="lotesActivos">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="tablaInventario">
                                    <thead>
                                        <tr>
                                            <th>Lote</th>
                                            <th>Producto</th>
                                            <th>Cantidad</th>
                                            <th>Precio Compra</th>
                                            <th>Precio Venta</th>
                                            <th>Fecha Ingreso</th>
                                            <th>Fecha Vencimiento</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Lotes se cargan aquí -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección Reportes -->
                <div id="seccion-reportes" class="seccion" style="display: none;">
                    <h2><i class="fas fa-file-alt me-2"></i>Reportes y Análisis</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                    <h5>Reporte de Ventas</h5>
                                    <button class="btn btn-primary" onclick="generarReporteVentas()">
                                        Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-dollar-sign fa-3x text-success mb-3"></i>
                                    <h5>Reporte de Ganancias</h5>
                                    <button class="btn btn-success" onclick="generarReporteGanancias()">
                                        Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-boxes fa-3x text-warning mb-3"></i>
                                    <h5>Reporte de Inventario</h5>
                                    <button class="btn btn-warning" onclick="generarReporteInventario()">
                                        Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                                    <h5>Reporte de Clientes</h5>
                                    <button class="btn btn-info" onclick="generarReporteClientes()">
                                        Generar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="reporteResultado" class="card" style="display: none;">
                        <div class="card-header">
                            <h5 id="reporteTitulo">Resultado del Reporte</h5>
                        </div>
                        <div class="card-body" id="reporteContenido">
                            <!-- Contenido del reporte -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let chartVentas, chartProductos;
        
        document.addEventListener('DOMContentLoaded', function() {
            cargarDashboard();
            inicializarGraficos();
        });
        
        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(s => s.style.display = 'none');
            
            // Mostrar la sección seleccionada
            document.getElementById(`seccion-${seccion}`).style.display = 'block';
            
            // Actualizar navegación
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            // Cargar datos específicos de la sección
            switch(seccion) {
                case 'productos':
                    cargarProductos();
                    break;
                case 'inventario':
                    cargarInventario();
                    break;
                case 'ventas':
                    cargarVentas();
                    break;
                case 'clientes':
                    cargarClientes();
                    break;
                case 'proveedores':
                    cargarProveedores();
                    break;
            }
        }
        
        function cargarDashboard() {
            // Cargar estadísticas generales
            fetch('/api/admin/estadisticas')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalProductos').textContent = data.totalProductos || 0;
                    document.getElementById('ventasHoy').textContent = '$' + (data.ventasHoy || 0);
                    document.getElementById('stockBajo').textContent = data.stockBajo || 0;
                    document.getElementById('totalClientes').textContent = data.totalClientes || 0;
                })
                .catch(error => console.error('Error:', error));
        }
        
        function inicializarGraficos() {
            // Gráfico de ventas
            const ctxVentas = document.getElementById('chartVentas').getContext('2d');
            chartVentas = new Chart(ctxVentas, {
                type: 'line',
                data: {
                    labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                    datasets: [{
                        label: 'Ventas ($)',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Gráfico de productos
            const ctxProductos = document.getElementById('chartProductos').getContext('2d');
            chartProductos = new Chart(ctxProductos, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
            
            // Cargar datos reales de los gráficos
            cargarDatosGraficos();
        }
        
        function cargarDatosGraficos() {
            // Cargar datos de ventas de los últimos 7 días
            fetch('/api/admin/ventas-semana')
                .then(response => response.json())
                .then(data => {
                    chartVentas.data.datasets[0].data = data.ventas || [0, 0, 0, 0, 0, 0, 0];
                    chartVentas.update();
                })
                .catch(error => console.error('Error:', error));
            
            // Cargar productos más vendidos
            fetch('/api/admin/productos-mas-vendidos')
                .then(response => response.json())
                .then(data => {
                    chartProductos.data.labels = data.nombres || [];
                    chartProductos.data.datasets[0].data = data.cantidades || [];
                    chartProductos.update();
                })
                .catch(error => console.error('Error:', error));
        }
        
        function cargarProductos() {
            fetch('/api/productos/admin')
                .then(response => response.json())
                .then(productos => {
                    const tbody = document.querySelector('#tablaProductos tbody');
                    tbody.innerHTML = '';
                    
                    productos.forEach(producto => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${producto.idProducto}</td>
                                <td>${producto.nombre}</td>
                                <td>${producto.codigoBarras}</td>
                                <td>${producto.categoria?.nombre || 'N/A'}</td>
                                <td>${producto.marca?.nombre || 'N/A'}</td>
                                <td class="${producto.stockActual <= producto.stockMinimo ? 'text-danger' : ''}">${producto.stockActual}</td>
                                <td>$${producto.precio || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="editarProducto(${producto.idProducto})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="eliminarProducto(${producto.idProducto})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(error => console.error('Error:', error));
        }
        
        function imprimirInventario() {
            window.open('/api/admin/imprimir-inventario', '_blank');
        }
        
        function generarReporteVentas() {
            fetch('/api/admin/reporte-ventas')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('reporteTitulo').textContent = 'Reporte de Ventas';
                    document.getElementById('reporteContenido').innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                <h5>Ventas del Día</h5>
                                <h3 class="text-success">$${data.ventasHoy || 0}</h3>
                            </div>
                            <div class="col-md-4">
                                <h5>Ventas del Mes</h5>
                                <h3 class="text-primary">$${data.ventasMes || 0}</h3>
                            </div>
                            <div class="col-md-4">
                                <h5>Total de Transacciones</h5>
                                <h3 class="text-info">${data.totalTransacciones || 0}</h3>
                            </div>
                        </div>
                    `;
                    document.getElementById('reporteResultado').style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
        }
        
        function generarReporteGanancias() {
            fetch('/api/admin/reporte-ganancias')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('reporteTitulo').textContent = 'Reporte de Ganancias';
                    document.getElementById('reporteContenido').innerHTML = `
                        <div class="row">
                            <div class="col-md-3">
                                <h5>Ganancia Bruta</h5>
                                <h3 class="text-success">$${data.gananciaBruta || 0}</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>Costos</h5>
                                <h3 class="text-danger">$${data.costos || 0}</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>Ganancia Neta</h5>
                                <h3 class="text-primary">$${data.gananciaNeta || 0}</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>Margen (%)</h5>
                                <h3 class="text-info">${data.margen || 0}%</h3>
                            </div>
                        </div>
                    `;
                    document.getElementById('reporteResultado').style.display = 'block';
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
